<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pushkar G. Ghanekar">

<title>Classifying reactions using machine-learning – Omnis tempus datum</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-638ce43a2b8cb8132871590242e342ae.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Omnis tempus datum</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pgg1610"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mepgg"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Classifying reactions using machine-learning</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">python</div>
                <div class="quarto-category">chemical-science</div>
                <div class="quarto-category">data-analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Pushkar G. Ghanekar </p>
            </div>
    </div>
      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#viewing-it-as-pandas-dataframe" id="toc-viewing-it-as-pandas-dataframe" class="nav-link active" data-scroll-target="#viewing-it-as-pandas-dataframe">Viewing it as Pandas dataframe</a></li>
  <li><a href="#fingerprints-in-rdkit" id="toc-fingerprints-in-rdkit" class="nav-link" data-scroll-target="#fingerprints-in-rdkit">Fingerprints in RDkit</a>
  <ul class="collapse">
  <li><a href="#function-to-include-agent-in-the-fps" id="toc-function-to-include-agent-in-the-fps" class="nav-link" data-scroll-target="#function-to-include-agent-in-the-fps">Function to include agent in the FPs</a></li>
  <li><a href="#function-to-convert-sparse-to-numpy-array" id="toc-function-to-convert-sparse-to-numpy-array" class="nav-link" data-scroll-target="#function-to-convert-sparse-to-numpy-array">Function to convert sparse to numpy array</a></li>
  <li><a href="#convert-the-rxn-objects-to-fps-and-save-pickle" id="toc-convert-the-rxn-objects-to-fps-and-save-pickle" class="nav-link" data-scroll-target="#convert-the-rxn-objects-to-fps-and-save-pickle">Convert the rxn objects to FPs and save pickle</a></li>
  <li><a href="#make-training-and-test-set" id="toc-make-training-and-test-set" class="nav-link" data-scroll-target="#make-training-and-test-set">Make training and test set</a>
  <ul class="collapse">
  <li><a href="#option-1-ohe" id="toc-option-1-ohe" class="nav-link" data-scroll-target="#option-1-ohe">Option 1: OHE</a></li>
  <li><a href="#option-2-leave-as-is" id="toc-option-2-leave-as-is" class="nav-link" data-scroll-target="#option-2-leave-as-is">Option 2: Leave as is</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random Forest</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="what" class="level4">
<h4 class="anchored" data-anchor-id="what">What?</h4>
<p>Using data-driven methods to classify reactions in different categories.</p>
</section>
<section id="why" class="level4">
<h4 class="anchored" data-anchor-id="why">Why?</h4>
<p>Categorically sorting (new) reactions can help with better documentation and developing a broader understanding of mechanisms possibles in the reactions.</p>
</section>
<section id="how" class="level4">
<h4 class="anchored" data-anchor-id="how">How?</h4>
<p>A chemical reaction is descirbed using a three-level reaction ontology based on the hierarchy proposed by Carey, Laffan, Thomson and Williams in 2006.</p>
<p>In this scheme, every reaction is grouped using 3 layers of information: superclass &gt;&gt; class &gt;&gt; type</p>
<p>Fo example: Suzuki reaction is as follows:</p>
<pre><code>"3 Carbon-Carbon bond formation" (Superclass)
    |- "3.1. Suzuki coupling" (Class)
        |- 3.1.1 Bromo OR 3.1.2 Chloro OR 3.1.3 Iodo Suzuki Coupling (Type)
    |- "3.5 Palladium-catalyzed C-C bond formation" (Class) 
        |- 3.5.3 Negishi coupling (Type)</code></pre>
<p>Researchers at <a href="https://www.nextmovesoftware.com/namerxn.html">NextMove software</a> were among the first groups to scrap US Patent literature for chemical reactions and use the categories defined above to systematically classify the reactions.</p>
<p>Another important step in this process is the atom-atom mapping of the chemical reactions. While not a crucial step (as newer algorithms can perform this task without explicit atom-mapping) it is an important pre-processing standardization operation.</p>
<p>Atom-atom mapping helps to understand which reactant atom becomes which product atom during the reaction. From this information it is possible to identify reaction centers and sets of bonds made and broken during the reaction.</p>
<p>This is also useful in distinguishing reactants and products.</p>
<p><strong>By convention:</strong></p>
<p>Reactant: Contribute one more more atoms to the product</p>
<p>Reagents (solvent, catalyst): Do not contribute any atom to the product(s)</p>
<p>Relevant papers in this field can be found <a href="https://pgg1610.github.io/blog_fastpages/chemical-science/machine-learning/resources/2021/05/08/Cheminformatics_Resources.html#computer-aided-synthesis-planning-casp">here</a></p>
<p>Using the Schneider et. al.&nbsp;paper for reference - https://pubs.acs.org/doi/10.1021/ci5006614</p>
<div id="cell-2" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rdkit</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> Chem </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> AllChem</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> Draw </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem.Draw <span class="im">import</span> IPythonConsole </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>IPythonConsole.ipython_useSVG<span class="op">=</span><span class="va">True</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> cPickle <span class="im">as</span> pickle </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>: </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pickle </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View reactions </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_rxn(rxn_smarts):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    rxn <span class="op">=</span> AllChem.ReactionFromSmarts(rxn_smarts,useSmiles<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    d2d <span class="op">=</span> Draw.MolDraw2DCairo(<span class="dv">800</span>,<span class="dv">200</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    d2d.DrawReaction(rxn)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    png <span class="op">=</span> d2d.GetDrawingText()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Image(png)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mute all errors except critical</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>Chem.WrapLogs()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>lg <span class="op">=</span> rdkit.RDLogger.logger() </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>lg.setLevel(rdkit.RDLogger.CRITICAL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.pyplot <span class="im">import</span> cm</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># High DPI rendering for mac</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'retina'</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot matplotlib plots with white background: </span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.print_figure_kwargs<span class="op">=</span>{<span class="st">'facecolor'</span> : <span class="st">"w"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data directories </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> <span class="st">'DATA/Schneider_etal_ChemReactionClassification/data'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reaction types</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(os.path.join(data_dir, <span class="st">'reactionTypes_training_test_set_patent_data.pkl'</span>), <span class="st">'rb'</span>) <span class="im">as</span> f: </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    reaction_types <span class="op">=</span> pickle.load(f)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># reaction classification data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(os.path.join(data_dir, <span class="st">'names_rTypes_classes_superclasses_training_test_set_patent_data.pkl'</span>), <span class="st">'rb'</span>) <span class="im">as</span> f: </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    names_rTypes <span class="op">=</span> pickle.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(reaction_types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>50</code></pre>
</div>
</div>
<p>names_rTypes is a super set of all possible reaction there are</p>
<div id="cell-12" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>names_rTypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>{'3.1.1': 'Bromo Suzuki coupling',
 '6.1.5': 'N-Bn deprotection',
 '3.1.6': 'Chloro Suzuki-type coupling',
 '3.1.5': 'Bromo Suzuki-type coupling',
 '6.1.1': 'N-Boc deprotection',
 '9.1.6': 'Hydroxy to chloro',
 '7.2': 'Amide to amine reduction',
 '7.3': 'Cyano or imine to amine',
 '7.1': 'Nitro to amine reduction',
 '6.3': 'ROH deprotections',
 '6.2': 'RCO2H deprotections',
 '6.1': 'NH deprotections',
 '7.9': 'Other reductions',
 '6.1.3': 'N-Cbz deprotection',
 '10.1': 'Halogenation',
 '10.2': 'Nitration',
 '10.4': 'Other functional group addition',
 '1.6.2': 'Bromo N-alkylation',
 '1.6.4': 'Chloro N-alkylation',
 '8': 'Oxidations',
 '1.6.8': 'Iodo N-alkylation',
 '1.7.7': 'Mitsunobu aryl ether synthesis',
 '1.8.5': 'Thioether synthesis',
 '10.1.1': 'Bromination',
 '10.1.2': 'Chlorination',
 '10.1.5': 'Wohl-Ziegler bromination',
 '9.3.1': 'Carboxylic acid to acid chloride',
 '7.9.2': 'Carboxylic acid to alcohol reduction',
 '3.4': 'Stille reaction',
 '3.3': 'Sonogashira reaction',
 '3.1': 'Suzuki coupling',
 '2.3': 'N-acylation to urea',
 '2.2': 'N-sulfonylation',
 '2.1': 'N-acylation to amide',
 '2.7': 'O-sulfonylation',
 '2.6': 'O-acylation to ester',
 '7.2.1': 'Amide to amine reduction',
 '3': 'C-C bond formation',
 '7': 'Reductions',
 '10.4.2': 'Methylation',
 '3.4.1': 'Stille reaction',
 '6.2.1': 'CO2H-Et deprotection',
 '6.2.3': 'CO2H-tBu deprotection',
 '6.2.2': 'CO2H-Me deprotection',
 '2.2.3': 'Sulfonamide Schotten-Baumann',
 '8.1': 'Alcohols to aldehydes',
 '8.2': 'Oxidations at sulfur',
 '10.2.1': 'Nitration',
 '2': 'Acylation and related processes',
 '6': 'Deprotections',
 '9.1': 'Alcohol to halide',
 '9.3': 'Acid to acid chloride',
 '1.3.7': 'Chloro N-arylation',
 '1.3.6': 'Bromo N-arylation',
 '1.3.8': 'Fluoro N-arylation',
 '8.2.1': 'Sulfanyl to sulfinyl',
 '10': 'Functional group addition (FGA)',
 '2.6.1': 'Ester Schotten-Baumann',
 '2.6.3': 'Fischer-Speier esterification',
 '3.3.1': 'Sonogashira coupling',
 '6.3.7': 'Methoxy to hydroxy',
 '6.3.1': 'O-Bn deprotection',
 '1.6': 'Heteroaryl N-alkylation',
 '1.7': 'O-substitution',
 '1.2': 'Reductive amination',
 '1.3': 'N-arylation with Ar-X',
 '1.8': 'S-substitution',
 '2.7.2': 'Sulfonic ester Schotten-Baumann',
 '2.1.2': 'Carboxylic acid + amine reaction',
 '2.1.1': 'Amide Schotten-Baumann',
 '2.1.7': 'N-acetylation',
 '5.1': 'NH protections',
 '1': 'Heteroatom alkylation and arylation',
 '5': 'Protections',
 '1.7.9': 'Williamson ether synthesis',
 '9': 'Functional group interconversion (FGI)',
 '1.7.6': 'Methyl esterification',
 '1.7.4': 'Hydroxy to methoxy',
 '2.3.1': 'Isocyanate + amine reaction',
 '1.2.4': 'Eschweiler-Clarke methylation',
 '1.2.5': 'Ketone reductive amination',
 '1.2.1': 'Aldehyde reductive amination',
 '8.1.4': 'Alcohol to aldehyde oxidation',
 '8.1.5': 'Alcohol to ketone oxidation',
 '5.1.1': 'N-Boc protection',
 '7.1.1': 'Nitro to amino',
 '7.3.1': 'Nitrile reduction'}</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading the rxn files  </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>infile <span class="op">=</span> gzip.<span class="bu">open</span>( os.path.join(data_dir, <span class="st">'training_test_set_patent_data.pkl.gz'</span>), <span class="st">'rb'</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>rxn_data_list <span class="op">=</span> []</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>lineNo <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    lineNo<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        smi,lbl,klass <span class="op">=</span> pickle.load(infile) </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">EOFError</span>:</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    rxn_data_list.append([smi,lbl,klass])</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lineNo<span class="op">%</span><span class="dv">10000</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Done "</span><span class="op">+</span><span class="bu">str</span>(lineNo))        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done 10000
Done 20000
Done 30000
Done 40000
Done 50000</code></pre>
</div>
</div>
<div id="cell-15" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(rxn_data_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>50000</code></pre>
</div>
</div>
</section>
<section id="viewing-it-as-pandas-dataframe" class="level2">
<h2 class="anchored" data-anchor-id="viewing-it-as-pandas-dataframe">Viewing it as Pandas dataframe</h2>
<div id="cell-17" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>column_names <span class="op">=</span> [<span class="st">'SMILES'</span>, <span class="st">'Patent No'</span>, <span class="st">'Rxn Class'</span>]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_rxn <span class="op">=</span> pd.DataFrame(rxn_data_list, columns<span class="op">=</span>column_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_rxn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMILES</th>
<th data-quarto-table-cell-role="th">Patent No</th>
<th data-quarto-table-cell-role="th">Rxn Class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>[CH3:17][S:14](=[O:15])(=[O:16])[N:11]1[CH2:10...</td>
<td>US06887874</td>
<td>6.1.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>O.O.[Na+].[CH3:1][c:2]1[cH:7][c:6]([N+:8](=O)[...</td>
<td>US07056926</td>
<td>7.1.1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>[CH3:1][O:2][c:3]1[cH:4][cH:5][c:6](-[c:9]2[cH...</td>
<td>US08492378</td>
<td>1.8.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Cl.[CH3:43][CH2:42][S:44](=[O:45])(=[O:46])Cl....</td>
<td>US08592454</td>
<td>2.2.3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>[CH3:25][O:24][c:21]1[cH:22][cH:23][c:17]([O:1...</td>
<td>US06716851</td>
<td>1.3.7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">49995</td>
<td>[BH4-].[Na+].[CH3:25][O:24][c:19]1[cH:18][c:17...</td>
<td>US08324216</td>
<td>7.3.1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49996</td>
<td>[BH4-].[Na+].[N:30]#[C:29][c:26]1[cH:25][cH:24...</td>
<td>US07595398</td>
<td>7.3.1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">49997</td>
<td>[N:15]#[C:14][CH2:13][c:1]1[cH:2][n:3][n:4]2[c...</td>
<td>US08273761</td>
<td>7.3.1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49998</td>
<td>B.Cl.CO.[CH3:12][C:8]([OH:13])([CH2:9][C:10]#[...</td>
<td>US08609849</td>
<td>7.3.1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">49999</td>
<td>[CH3:2][CH2:1][O:3][C:4](=[O:5])[C:6]1([C:14]#...</td>
<td>US07030267</td>
<td>7.3.1</td>
</tr>
</tbody>
</table>

<p>50000 rows × 3 columns</p>
</div>
</div>
</div>
<div id="cell-19" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_rxn.dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>SMILES       object
Patent No    object
Rxn Class    object
dtype: object</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_rxn[<span class="st">'Rxn Class'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>6.1.5     1000
3.3.1     1000
1.3.8     1000
1.3.6     1000
3.1.5     1000
6.2.3     1000
3.4.1     1000
6.1.3     1000
1.7.6     1000
10.1.2    1000
9.1.6     1000
10.1.5    1000
10.4.2    1000
7.1.1     1000
6.3.1     1000
1.7.7     1000
7.9.2     1000
8.1.5     1000
1.7.4     1000
7.2.1     1000
8.1.4     1000
8.2.1     1000
7.3.1     1000
2.1.7     1000
9.3.1     1000
6.1.1     1000
6.3.7     1000
2.1.2     1000
1.8.5     1000
2.2.3     1000
1.3.7     1000
1.7.9     1000
6.2.2     1000
2.7.2     1000
2.6.1     1000
1.6.8     1000
3.1.1     1000
1.6.2     1000
1.2.1     1000
1.6.4     1000
1.2.5     1000
2.3.1     1000
5.1.1     1000
10.1.1    1000
2.1.1     1000
2.6.3     1000
6.2.1     1000
10.2.1    1000
1.2.4     1000
3.1.6     1000
Name: Rxn Class, dtype: int64</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_rxn.iloc[<span class="dv">42069</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>SMILES       [H][H].[O:32]=[C:18]1[NH:17][C:16](=[O:33])[C@...
Patent No                                           US08377927
Rxn Class                                                6.3.1
Name: 42069, dtype: object</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_rxn.SMILES[<span class="dv">42069</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>'[H][H].[O:32]=[C:18]1[NH:17][C:16](=[O:33])[C@@H:15]([c:12]2[cH:11][cH:10][c:9]([O:8]Cc3ccccc3)[cH:14][cH:13]2)[C@@H:19]1[c:20]1[cH:21][n:22]2[c:31]3[c:30]1[cH:29][cH:28][cH:27][c:26]3[CH2:25][CH2:24][CH2:23]2&gt;&gt;[O:32]=[C:18]1[NH:17][C:16](=[O:33])[C@@H:15]([c:12]2[cH:13][cH:14][c:9]([OH:8])[cH:10][cH:11]2)[C@@H:19]1[c:20]1[cH:21][n:22]2[c:31]3[c:30]1[cH:29][cH:28][cH:27][c:26]3[CH2:25][CH2:24][CH2:23]2'</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>display_rxn(df_rxn.SMILES[<span class="dv">42069</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="2021_07_28-USPTO_rxn_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Generate Chemical Entries object in Rdkit from the RXN SMILES</p>
<div id="cell-25" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Smiles strings to reaction objects - this takes the most time and might be helpful if parallelized </span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdChemReactions <span class="co"># Main reaction analysis class </span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>df_rxn[<span class="st">'rxn_obj'</span>] <span class="op">=</span> df_rxn[<span class="st">'SMILES'</span>].<span class="bu">apply</span>(rdChemReactions.ReactionFromSmarts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 13.9 s, sys: 1.61 s, total: 15.5 s
Wall time: 15.5 s</code></pre>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_rxn[<span class="st">'rxn_obj'</span>][<span class="dv">42069</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<figure class="figure">
<p><img src="2021_07_28-USPTO_rxn_files/figure-html/cell-23-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>temp_rxn <span class="op">=</span> df_rxn[<span class="st">'rxn_obj'</span>][<span class="dv">42069</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(temp_rxn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>rdkit.Chem.rdChemReactions.ChemicalReaction</code></pre>
</div>
</div>
</section>
<section id="fingerprints-in-rdkit" class="level1">
<h1>Fingerprints in RDkit</h1>
<p>More information here: https://www.rdkit.org/UGM/2012/Landrum_RDKit_UGM.Fingerprints.Final.pptx.pdf</p>
<p>Base reaction class in RDKit reaction class now moved to a new class name: http://rdkit.org/docs/source/rdkit.Chem.rdChemReactions.html</p>
<p>Here I am using Reaction Difference FPs for converting to FPs - another option is to use the Transformation FPs</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Fingerprint Type</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Difference FPs</td>
<td>Take difference of structural FPs of reactant and product</td>
</tr>
<tr class="even">
<td>Structural FPs</td>
<td>Concatenate the FPs of reactant and product in 1 vector</td>
</tr>
</tbody>
</table>
<p>Another option: - Adding in agent during the fingerprint generation – weighting its importance - Appending the agent after the FP formation</p>
<div id="cell-30" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check to see if you can convert this to RDkit FPs  </span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>AllChem.ReactionFingerprintParams()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>&lt;rdkit.Chem.rdChemReactions.ReactionFingerprintParams at 0x2ba8fcb9f670&gt;</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>Chem.rdChemReactions.ReactionFingerprintParams()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>&lt;rdkit.Chem.rdChemReactions.ReactionFingerprintParams at 0x2ba8fcb988b0&gt;</code></pre>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>rdChemReactions.CreateDifferenceFingerprintForReaction(temp_rxn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>&lt;rdkit.DataStructs.cDataStructs.UIntSparseIntVect at 0x2ba8fcfa87b0&gt;</code></pre>
</div>
</div>
<section id="function-to-include-agent-in-the-fps" class="level3">
<h3 class="anchored" data-anchor-id="function-to-include-agent-in-the-fps">Function to include agent in the FPs</h3>
<div id="cell-34" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Featurize the agents in the rxn </span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">## This is taken from the paper SI </span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_agent_feature_FP(rxn):    </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    rxn.RemoveUnmappedReactantTemplates()</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    agent_feature_Fp <span class="op">=</span> [<span class="fl">0.0</span>]<span class="op">*</span><span class="dv">9</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> nra <span class="kw">in</span> <span class="bu">range</span>(rxn.GetNumAgentTemplates()):</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> rxn.GetAgentTemplate(nra)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        mol.UpdatePropertyCache(strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        Chem.GetSSSR(mol)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            ri <span class="op">=</span> mol.GetRingInfo()</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">0</span>] <span class="op">+=</span> Descriptors.MolWt(mol)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">1</span>] <span class="op">+=</span> mol.GetNumAtoms()</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">2</span>] <span class="op">+=</span> ri.NumRings()</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">3</span>] <span class="op">+=</span> Descriptors.MolLogP(mol)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">4</span>] <span class="op">+=</span> Descriptors.NumRadicalElectrons(mol)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">5</span>] <span class="op">+=</span> Descriptors.TPSA(mol)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">6</span>] <span class="op">+=</span> Descriptors.NumHeteroatoms(mol)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">7</span>] <span class="op">+=</span> Descriptors.NumHAcceptors(mol)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>            agent_feature_Fp[<span class="dv">8</span>] <span class="op">+=</span> Descriptors.NumHDonors(mol)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span> </span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> agent_feature_Fp</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_agent_morgan2_FP(rxn):    </span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    rxn.RemoveUnmappedReactantTemplates()</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    morgan2 <span class="op">=</span> <span class="va">None</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> nra <span class="kw">in</span> <span class="bu">range</span>(rxn.GetNumAgentTemplates()):</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> rxn.GetAgentTemplate(nra)</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        mol.UpdatePropertyCache(strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        Chem.GetSSSR(mol)</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>            mg2 <span class="op">=</span> AllChem.GetMorganFingerprint(mol,radius<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> morgan2 <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> mg2 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>                morgan2 <span class="op">=</span> mg2</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> mg2 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>                morgan2 <span class="op">+=</span> mg2</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Cannot build agent Fp</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> morgan2 <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>        morgan2 <span class="op">=</span> DataStructs.UIntSparseIntVect(<span class="dv">2048</span>)</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> morgan2</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Include agents in the fingerprint as either a reactant or product</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a><span class="co">## Inputs are reaction object, fp_type object, int, int</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dictionary of all Molecular Fingerprinting types with names</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>fptype_dict <span class="op">=</span> {<span class="st">"AtomPairFP"</span>: AllChem.FingerprintType.AtomPairFP,</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>               <span class="st">"MorganFP"</span>: AllChem.FingerprintType.MorganFP, </span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>               <span class="st">"TopologicalFP"</span>: AllChem.FingerprintType.TopologicalTorsion, </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>               <span class="st">"PatternFP"</span>: AllChem.FingerprintType.PatternFP, </span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>               <span class="st">"RDKitFP"</span>: AllChem.FingerprintType.RDKitFP}</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a difference fingerprint for a ChemicalReaction by subtracting the reactant fingerprint from the product fingerprint</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> diff_fpgen(rxn, fptype_dict <span class="op">=</span> fptype_dict, fp_type <span class="op">=</span> <span class="st">'MorganFP'</span>, include_agent<span class="op">=</span><span class="va">True</span>, agent_weight<span class="op">=</span><span class="dv">1</span>, nonagent_weight<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> rdChemReactions.ReactionFingerprintParams()</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>    params.fptype <span class="op">=</span> fptype_dict[fp_type]</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>    params.includeAgents <span class="op">=</span> include_agent</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> include_agent <span class="op">==</span> <span class="va">True</span>: </span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a><span class="co">        If including agent then how is it weighted? </span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>        params.agentWeight <span class="op">=</span> agent_weight</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>        params.nonAgentWeight <span class="op">=</span> nonagent_weight</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>    fp <span class="op">=</span> rdChemReactions.CreateDifferenceFingerprintForReaction(rxn,params)</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="function-to-convert-sparse-to-numpy-array" class="level3">
<h3 class="anchored" data-anchor-id="function-to-convert-sparse-to-numpy-array">Function to convert sparse to numpy array</h3>
<div id="cell-36" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> DataStructs</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fingerprint2Numpy(FPs):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    fp_np <span class="op">=</span> np.zeros((<span class="dv">1</span>,))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    DataStructs.ConvertToNumpyArray(FPs, fp_np)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fp_np</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># convert a hashed SparseIntvect into a numpy float vector</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hashedFPToNPfloat(fp,fpsz<span class="op">=</span><span class="dv">2048</span>):</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    nfp <span class="op">=</span> np.zeros((fpsz,), <span class="bu">float</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx,v <span class="kw">in</span> fp.GetNonzeroElements().items():</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        nfp[idx]<span class="op">+=</span><span class="bu">float</span>(v)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nfp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="convert-the-rxn-objects-to-fps-and-save-pickle" class="level2">
<h2 class="anchored" data-anchor-id="convert-the-rxn-objects-to-fps-and-save-pickle">Convert the rxn objects to FPs and save pickle</h2>
<div id="cell-38" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_rxn.sample(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMILES</th>
<th data-quarto-table-cell-role="th">Patent No</th>
<th data-quarto-table-cell-role="th">Rxn Class</th>
<th data-quarto-table-cell-role="th">rxn_obj</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">37512</td>
<td>[OH-].[Na+].Cl.[K+].[BH3-]C#N.[CH3:5][CH2:4][N...</td>
<td>US06964966</td>
<td>1.2.5</td>
<td>&lt;rdkit.Chem.rdChemReactions.ChemicalReaction o...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">934</td>
<td>[OH-].[K+].[CH3:14][C@H:5]([CH2:6][c:7]1[cH:8]...</td>
<td>05166218</td>
<td>1.7.9</td>
<td>&lt;rdkit.Chem.rdChemReactions.ChemicalReaction o...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>df_rxn[<span class="st">'FP_Morgan_wo_agents'</span>] <span class="op">=</span> df_rxn[<span class="st">'rxn_obj'</span>].<span class="bu">apply</span>(diff_fpgen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 18.5 s, sys: 1.05 s, total: 19.5 s
Wall time: 19.6 s</code></pre>
</div>
</div>
<p>Adding in agents is giving me problem right now - debug it eventually</p>
<p>df_rxn[‘Agent_Morgan_FP2’] = df_rxn[‘rxn_obj’].apply(create_agent_feature_FP)</p>
</section>
<section id="make-training-and-test-set" class="level2">
<h2 class="anchored" data-anchor-id="make-training-and-test-set">Make training and test set</h2>
<div id="cell-43" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>X_FPs <span class="op">=</span> np.array( [hashedFPToNPfloat(x) <span class="cf">for</span> x <span class="kw">in</span> df_rxn[<span class="st">'FP_Morgan_wo_agents'</span>]] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 3.38 s, sys: 591 ms, total: 3.97 s
Wall time: 4 s</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>Y_class <span class="op">=</span> np.array( df_rxn[<span class="st">'Rxn Class'</span>] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-45" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rtypes <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(reaction_types))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>rtype_int <span class="op">=</span> [<span class="bu">int</span>(<span class="st">''</span>.join(entry.split(<span class="st">'.'</span>))) <span class="cf">for</span> entry <span class="kw">in</span> rtypes]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-47" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(<span class="bu">set</span>(rtype_int))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>50</code></pre>
</div>
</div>
<p>Note on multi-class classification:</p>
<p>https://scikit-learn.org/stable/modules/multiclass.html#multiclass-classification</p>
<p>LabelBinarizer is not needed if you are using an estimator that already supports multiclass data.</p>
<p>https://scikit-learn.org/stable/modules/preprocessing_targets.html#preprocessing-targets</p>
<section id="option-1-ohe" class="level3">
<h3 class="anchored" data-anchor-id="option-1-ohe">Option 1: OHE</h3>
<p>Create one hot encoding – does it help to create OHE now? Not sure but doing it here as a first pass.</p>
<p>Y_class_labels = [ rtypes.index(i) for i in Y_class]</p>
<p>Y_class_OHE = np.zeros(shape=(len(Y_class_labels), len(rtypes)), dtype=int) for i, j in enumerate(Y_class_labels): Y_class_OHE[i][j] = 1</p>
<p>rxn_dict = {i:0 for i in rtypes} for i, j in enumerate(Y_train): rxn_class_id = int(np.argmax(j)) rxn_dict[ rtypes[rxn_class_id] ] += 1</p>
<p>rxn_dict</p>
</section>
<section id="option-2-leave-as-is" class="level3">
<h3 class="anchored" data-anchor-id="option-2-leave-as-is">Option 2: Leave as is</h3>
<div id="cell-56" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>leave_as_is <span class="op">=</span> <span class="va">True</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> leave_as_is <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    Y_target <span class="op">=</span> Y_class</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>: </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    Y_target <span class="op">=</span> Y_class_OHE </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-57" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> StratifiedShuffleSplit</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>stratSplit <span class="op">=</span> StratifiedShuffleSplit(n_splits<span class="op">=</span><span class="dv">1</span>, test_size<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-58" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> stratSplit.split(X_FPs, Y_target):</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> X_FPs[train_idx]</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    Y_train <span class="op">=</span> Y_target[train_idx]</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> X_FPs[test_idx]</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    Y_test <span class="op">=</span> Y_target[test_idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="random-forest" class="level1">
<h1>Random Forest</h1>
<div id="cell-60" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> RandomForestClassifier(max_depth<span class="op">=</span><span class="dv">200</span>,n_estimators<span class="op">=</span><span class="dv">250</span>,random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, Y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>RandomForestClassifier(max_depth=200, n_estimators=250, random_state=42)</code></pre>
</div>
</div>
<div id="cell-61" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>Y_test_predict <span class="op">=</span> model.predict(X_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y_test_predict_classes = [ np.argmax(i) for i in Y_test_predict ]</p>
<p>Y_test_class = [ np.argmax(i) for i in Y_test ]</p>
<div id="cell-64" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, classification_report</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>report_real <span class="op">=</span> classification_report(Y_test, Y_test_predict, output_dict<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>cmat_real <span class="op">=</span> confusion_matrix(Y_test,Y_test_predict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(cmat_real,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>array([488, 517, 503, 515, 508, 494, 498, 473, 503, 529, 489, 442, 510,
       500, 480, 475, 504, 498, 475, 520, 476, 489, 502, 503, 519, 503,
       498, 479, 521, 495, 500, 497, 484, 534, 515, 516, 498, 494, 502,
       534, 499, 509, 506, 501, 503, 496, 498, 497, 504, 507])</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate model calculating recall, precision and F-score, return the confusion matrix</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluateModel(_model, _testFPs, _test_rxn_labels, _sorted_rxn_label, _names_rTypes):</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> _model.predict(_testFPs)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#pred_class = [ int(np.argmax(pred_entry)) for pred_entry in preds ]</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#testReactionTypes_class = [ int(np.argmax(test_entry))for test_entry in testReactionTypes ]</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    cmat <span class="op">=</span> metrics.confusion_matrix(_test_rxn_labels, preds)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    colCounts <span class="op">=</span> <span class="bu">sum</span>(cmat,<span class="dv">0</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    rowCounts <span class="op">=</span> <span class="bu">sum</span>(cmat,<span class="dv">1</span>)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="sc">%2s</span><span class="st"> </span><span class="sc">%7s</span><span class="st"> </span><span class="sc">%7s</span><span class="st"> </span><span class="sc">%7s</span><span class="st">     </span><span class="sc">%s</span><span class="st">'</span><span class="op">%</span>(<span class="st">"ID"</span>,<span class="st">"recall"</span>,<span class="st">"prec"</span>,<span class="st">"F-score "</span>,<span class="st">"reaction class"</span>))</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    sum_recall<span class="op">=</span><span class="dv">0</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    sum_prec<span class="op">=</span><span class="dv">0</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, rxn_class_label <span class="kw">in</span> <span class="bu">enumerate</span>(_sorted_rxn_label):</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>        recall <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rowCounts[i] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>            recall <span class="op">=</span> <span class="bu">float</span>(cmat[i,i])<span class="op">/</span>rowCounts[i]</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>        sum_recall <span class="op">+=</span> recall</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>        prec <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> colCounts[i] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>            prec <span class="op">=</span> <span class="bu">float</span>(cmat[i,i])<span class="op">/</span>colCounts[i]</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>        sum_prec <span class="op">+=</span> prec</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>        f_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (recall <span class="op">+</span> prec) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>            f_score <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (recall <span class="op">*</span> prec) <span class="op">/</span> (recall <span class="op">+</span> prec)   </span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="sc">%2d</span><span class="st"> </span><span class="sc">% .4f</span><span class="st"> </span><span class="sc">% .4f</span><span class="st"> </span><span class="sc">% .4f</span><span class="st"> </span><span class="sc">% 9s</span><span class="st"> </span><span class="sc">%s</span><span class="st">'</span><span class="op">%</span>(i, recall, prec, f_score,  rxn_class_label, _names_rTypes[rxn_class_label]))</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>    mean_recall <span class="op">=</span> sum_recall<span class="op">/</span><span class="bu">len</span>(_sorted_rxn_label)</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>    mean_prec <span class="op">=</span> sum_prec<span class="op">/</span><span class="bu">len</span>(_sorted_rxn_label)</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mean_recall <span class="op">+</span> mean_prec) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>        mean_fscore <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>(mean_recall<span class="op">*</span>mean_prec)<span class="op">/</span>(mean_recall<span class="op">+</span>mean_prec)</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Mean:</span><span class="sc">% 3.2f</span><span class="st"> </span><span class="sc">% 7.2f</span><span class="st"> </span><span class="sc">% 7.2f</span><span class="st">"</span><span class="op">%</span>(mean_recall,mean_prec,mean_fscore))</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cmat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-67" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>cmat_rFP_agentFeature <span class="op">=</span> evaluateModel(model, X_test, Y_test, rtypes, names_rTypes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ID  recall    prec F-score      reaction class
 0  0.9939  0.9959  0.9949     1.2.1 Aldehyde reductive amination
 1  0.9459  0.9478  0.9469     1.2.4 Eschweiler-Clarke methylation
 2  0.9821  0.9841  0.9831     1.2.5 Ketone reductive amination
 3  0.9516  0.9534  0.9525     1.3.6 Bromo N-arylation
 4  0.9666  0.9685  0.9676     1.3.7 Chloro N-arylation
 5  0.9818  0.9838  0.9828     1.3.8 Fluoro N-arylation
 6  0.9639  0.9659  0.9649     1.6.2 Bromo N-alkylation
 7  0.9810  0.9831  0.9820     1.6.4 Chloro N-alkylation
 8  0.9365  0.9384  0.9374     1.6.8 Iodo N-alkylation
 9  0.9245  0.9263  0.9254     1.7.4 Hydroxy to methoxy
10  0.9837  0.9857  0.9847     1.7.6 Methyl esterification
11  0.9865  0.9887  0.9876     1.7.7 Mitsunobu aryl ether synthesis
12  0.9413  0.9431  0.9422     1.7.9 Williamson ether synthesis
13  0.9900  0.9920  0.9910     1.8.5 Thioether synthesis
14  0.9854  0.9875  0.9865    10.1.1 Bromination
15  0.9874  0.9895  0.9884    10.1.2 Chlorination
16  0.9901  0.9921  0.9911    10.1.5 Wohl-Ziegler bromination
17  0.9920  0.9940  0.9930    10.2.1 Nitration
18  0.8634  0.8653  0.8644    10.4.2 Methylation
19  0.9347  0.9365  0.9356     2.1.1 Amide Schotten-Baumann
20  0.9748  0.9769  0.9759     2.1.2 Carboxylic acid + amine reaction
21  0.9776  0.9796  0.9785     2.1.7 N-acetylation
22  0.9901  0.9920  0.9910     2.2.3 Sulfonamide Schotten-Baumann
23  0.9921  0.9940  0.9930     2.3.1 Isocyanate + amine reaction
24  0.9558  0.9576  0.9567     2.6.1 Ester Schotten-Baumann
25  0.9841  0.9861  0.9851     2.6.3 Fischer-Speier esterification
26  0.9980  1.0000  0.9990     2.7.2 Sulfonic ester Schotten-Baumann
27  0.9792  0.9812  0.9802     3.1.1 Bromo Suzuki coupling
28  0.9368  0.9386  0.9377     3.1.5 Bromo Suzuki-type coupling
29  0.9980  1.0000  0.9990     3.1.6 Chloro Suzuki-type coupling
30  0.9940  0.9960  0.9950     3.3.1 Sonogashira coupling
31  0.9900  0.9920  0.9910     3.4.1 Stille reaction
32  0.9856  0.9876  0.9866     5.1.1 N-Boc protection
33  0.9327  0.9345  0.9336     6.1.1 N-Boc deprotection
34  0.9690  0.9709  0.9699     6.1.3 N-Cbz deprotection
35  0.9632  0.9651  0.9642     6.1.5 N-Bn deprotection
36  0.9800  0.9819  0.9809     6.2.1 CO2H-Et deprotection
37  0.9879  0.9899  0.9889     6.2.2 CO2H-Me deprotection
38  0.9901  0.9920  0.9910     6.2.3 CO2H-tBu deprotection
39  0.9327  0.9345  0.9336     6.3.1 O-Bn deprotection
40  0.9880  0.9900  0.9890     6.3.7 Methoxy to hydroxy
41  0.9784  0.9804  0.9794     7.1.1 Nitro to amino
42  0.9783  0.9802  0.9793     7.2.1 Amide to amine reduction
43  0.9861  0.9880  0.9870     7.3.1 Nitrile reduction
44  0.9881  0.9901  0.9891     7.9.2 Carboxylic acid to alcohol reduction
45  0.9980  1.0000  0.9990     8.1.4 Alcohol to aldehyde oxidation
46  0.9920  0.9940  0.9930     8.1.5 Alcohol to ketone oxidation
47  0.9960  0.9980  0.9970     8.2.1 Sulfanyl to sulfinyl
48  0.9703  0.9722  0.9713     9.1.6 Hydroxy to chloro
49  0.9764  0.9783  0.9773     9.3.1 Carboxylic acid to acid chloride
Mean: 0.97    0.97    0.97</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> labelled_cmat(cmat, labels, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">15</span>), labelExtras<span class="op">=</span><span class="va">None</span>, dpi<span class="op">=</span><span class="dv">300</span>, threshold<span class="op">=</span><span class="fl">0.01</span>, xlabel<span class="op">=</span><span class="va">True</span>, ylabel<span class="op">=</span><span class="va">True</span>, rotation<span class="op">=</span><span class="dv">90</span>):</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    rowCounts <span class="op">=</span> np.array(<span class="bu">sum</span>(cmat,<span class="dv">1</span>),dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    cmat_percent <span class="op">=</span> cmat <span class="op">/</span> rowCounts[:,<span class="va">None</span>]</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#zero all elements that are less than 1% of the row contents</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    ncm <span class="op">=</span> cmat_percent<span class="op">*</span>(cmat_percent<span class="op">&gt;</span>threshold)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>, figsize<span class="op">=</span>figsize)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    pax<span class="op">=</span>ax.pcolor(ncm,cmap<span class="op">=</span>cm.ocean_r)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    ax.set_frame_on(<span class="va">True</span>)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># put the major ticks at the middle of each cell</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    ax.set_yticks(np.arange(cmat.shape[<span class="dv">0</span>])<span class="op">+</span><span class="fl">0.5</span>, minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(np.arange(cmat.shape[<span class="dv">1</span>])<span class="op">+</span><span class="fl">0.5</span>, minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># want a more natural, table-like display</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    ax.invert_yaxis()</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.tick_top()</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> labelExtras <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [<span class="st">' </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">'</span><span class="op">%</span>(x,labelExtras[x].strip()) <span class="cf">for</span> x <span class="kw">in</span> labels]</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([], minor<span class="op">=</span><span class="va">False</span>) </span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([], minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> xlabel:</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels(labels, minor<span class="op">=</span><span class="va">False</span>, rotation<span class="op">=</span>rotation, horizontalalignment<span class="op">=</span><span class="st">'left'</span>) </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ylabel:</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>        ax.set_yticklabels(labels, minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>)</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    fig.colorbar(pax)</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'tight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>rowCounts <span class="op">=</span> np.array(<span class="bu">sum</span>(cmat_rFP_agentFeature,<span class="dv">1</span>),dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>cmat_percent <span class="op">=</span> cmat_rFP_agentFeature<span class="op">/</span>rowCounts[:,<span class="va">None</span>]</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co">#zero all elements that are less than 1% of the row contents</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>ncm <span class="op">=</span> cmat_percent<span class="op">*</span>(cmat_percent<span class="op">&gt;</span><span class="fl">0.01</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">15</span>))</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>pax<span class="op">=</span>ax.pcolor(ncm,cmap<span class="op">=</span>cm.ocean_r)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>ax.set_frame_on(<span class="va">True</span>)</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">' </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">'</span><span class="op">%</span>(x,names_rTypes[x].strip()) <span class="cf">for</span> x <span class="kw">in</span> rtypes]</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(np.arange(cmat_rFP_agentFeature.shape[<span class="dv">0</span>])<span class="op">+</span><span class="fl">0.5</span>, minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(np.arange(cmat_rFP_agentFeature.shape[<span class="dv">1</span>])<span class="op">+</span><span class="fl">0.5</span>, minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(labels, minor<span class="op">=</span><span class="va">False</span>, rotation<span class="op">=</span><span class="dv">90</span>, horizontalalignment<span class="op">=</span><span class="st">'left'</span>) </span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(labels, minor<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a><span class="co"># want a more natural, table-like display</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>ax.xaxis.tick_top()</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2021_07_28-USPTO_rxn_files/figure-html/cell-48-output-1.png" width="1348" height="1047" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>